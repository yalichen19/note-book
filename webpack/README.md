# webpack

## webpack 的本质 / 解决的问题
webpack 是前端构建工具之一，用于将开发环境代码转换为生产环境代码。至于为什么要区分生产环境和开发环境，可以看上一章。

## webpack 的特点
webpacl是基于模块化的打包（构建）工具，把一切视为模块化。

它通过一个开发时态的入口模块为起点，分析出所有的依赖关系，然后经过一系列的过程（压缩、合并），最终生成运行时的态的文件。

还有以下的特点：
- 为前端工程化而生：致力于解决前端工程化的问题，让开发者集中注意编写业务代码，而把工程化问题给 webpack 解决。
- 简单易用，支持零配置
- 强大的生态，有良好的扩展机制，因此有大量第三方库可使用
- 基于node，打包的过程运行在 node 
环境，生成的代码运行在浏览器等其他环境
- 基于模块化：构建过程中会分析依赖，而分析的方式是基于模块化语句导入导出语句进行分析的，它支持各种模块化标准，包括但不限于CommonJs、ES6 Module

## webpack 的组成
npm 提供了两个包
- webpack： 核心包，包含 webpack 构建过程中使用的所有 api。
- webpack-cli：提供一个简单的 cli 命令，它调用 webpack 核心包的 api，来完成构建过程。不用 webpack-cli 的话，也可以直接通过 js 调用核心包的 api 完成构建。

## webpack 的编译过程
webpack 的作用是将源代码编译（构建、打包）成最终代码，整个过程大致分为3个步骤
1. 初始化
2. 编译
3. 输出

### 初始化
这个阶段，webpack 会将 **cli配置**、**配置文件**、**默认配置**仅需合并，形成一个最终的配置对象。

对配置的处理过程是依托于第三方库 yargs 完成的

因此初始化简单说就是生成配置对象

### 编译 （ watch 的更新不再初始化，而从编译执行）
1. 创建 chunk 

    chunk 是 webpack 在内部构建过程中的一个概念，它表示从某个入口找到所有依赖的统称。
    
    如果入口配置较简单，可以简单认为从入口文件找到的所有依赖就是一个chunk

    每一个 chunk 都至少有两个属性：
    - name： 默认为main
    - id：唯一编号，开发环境和 name 相同，生产环境是一个数字，从 0 开始

2. 构建所有依赖模块，即要找出所有依赖，并为其替换依赖函数生成转换后的代码。

    一个chunk的构建过程：

    1. 从入口开始读取模块文件路径
    2. 根据路径检查**结果记录**（记录1），已记录则结束，未记录则继续
    3. 根据路径读取文件内容
    4. 语法分析文件内容生成 AST（抽象语法树） 
    5. 记录依赖，保存到 **dependencies** （记录2，临时记录）中
    6. 替换依赖函数
    7. 保存转换后的模块代码到**结果记录**（记录1）
    8. 根据 **dependencies** （记录2）的内容递归加载模块，回到1执行递归

    一个chunk的构建结果：生成**结果记录**（记录1）,即每个模块id（路径）和转换后代码的表格，如

    结果记录
    模块id | content
    ---- | ---
    ./src/index.js | __webpack__require__('./src/a.js'）...
    ./src/a.js |  console.log('a')

3. 产生chunk assets ，生成 chunk hash
根据配置和 chunk 的构建结果记录生成一个资源列表，即 chunk assets。
    
    资源列表可以理解为生成到最终文件的文件名和文件内容。如：

    chunk assets
    chunk id | content
    ---- | ---
    ./dist/main.js | （function(){// 调用入口模块}({// 每个模块}))
    ./dist/main.js.map | xxx
    chunk hash: xxxxxxxxxxxxxxxxxxxxxxxx
    
    相当于把结果记录的多个模块按照通用模版生成最终打包结果的内容，同时 souce map 文件内容，也在这个过程中产生。

    其中每个资源项目，为一个 bundle。

    hash：一种算法，特点是把一个任意长度的字符串转换为一个固定长度的字符串，而且可以保证原生内容不变，则生成的hash字符串也不变。可以用于快速判断文件内容是否改变。

4. 重复上述 123 把所有入口对应的 chunk assets 生成，然后整合为一个总的 assets ，和总的 hash

### 输出
根据总的 assets ， 输出文件

## 涉及术语
- module ：模块，分隔代码的单元，可以是图片，js等等
- chunk ：webpack 内部构建的分隔单位，从一个入口文件找到的所有依赖就是一个chunk
- bundle ：构建完成的资源清单的每一项，包含多个模块的整合代码，也是最终生成的文件
- hash ：打包最终所有内容联合生成的 hash 值
- chunkhash： 一个 chunk 所有内容联合生成的 hash 值
- chunkname： chunk 的名称，默认为 main
- id ： 通常指 chunk 的唯一编号，开发环境和 name 相同，生产环境是一个数字，从 0 开始






   



    

 

